// 日報データ（直接埋め込み）
const REPORT_DATA = {
    '2025-11-01': `# 日報

## 基本情報
- **日付**：2025年11月1日
- **氏名**：

## 本日の業務内容
- 9:00～12:00　
  - デイリースタンドアップで、今週の重要タスクの進捗を確認しました。特に、来週提出予定の提案書について、各メンバーの担当部分の進捗状況を共有し、スケジュールの調整を行いました。
  - クライアント向けの提案書の作成を開始しました。まず、プロジェクトの背景と目的を整理し、提案の骨子を作成しました。市場分析のセクションについて、必要なデータの収集を依頼しました。
  - 来週開催予定のCursor講座の企画を進めました。参加者の事前アンケート結果を分析し、期待される内容やレベル感を把握しました。これに基づいて、講座の構成を再検討しました。
- 13:00～15:00　
  - 既存顧客との定期ミーティングに参加しました。現在進行中のプロジェクトの進捗を報告し、顧客からのフィードバックを受け取りました。いくつかの要望について、実現可能性を検討し、次回までに回答することを約束しました。
  - 広告キャンペーンの効果測定結果を分析しました。先月実施したABテストのデータを集計し、各バリエーションのパフォーマンスを比較しました。結果を基に、次回のキャンペーン戦略を検討しました。
- 15:00～18:00　
  - 動画編集プロジェクトのキックオフミーティングに参加しました。クライアントの要望を詳細に確認し、制作スケジュールと納期を確定しました。各工程の担当者を決定し、コミュニケーション体制を整えました。
  - 開発チームと連携し、新機能のリリース準備を進めました。ステージング環境での最終テストを実施し、問題がないことを確認しました。リリースノートの作成も完了し、明日の本番リリースに向けて準備を整えました。
  - セミナー開催の企画を進めました。テーマと講師の選定について検討し、候補を絞り込みました。会場の選定についても、複数の候補をリストアップし、比較検討を開始しました。`,
    '2025-11-02': `# 日報

## 基本情報
- **日付**：2025年11月2日
- **氏名**：

## 本日の業務内容
- 9:00～12:00　
  - 週末のため、通常業務は休業でした。ただし、緊急対応が必要な案件については、リモートで対応しました。
  - 来週提出予定の提案書の作成を進めました。自宅で作業環境を整え、資料の作成とデータの整理を行いました。特に、プロジェクトの背景と目的を整理し、提案の骨子を作成しました。
- 13:00～15:00　
  - 提案書の作成を継続しました。クライアントの課題を分析し、我々のソリューションがどのように貢献できるかを整理しました。データの収集と分析も進めました。
  - 来週のスケジュールを確認し、重要なタスクをリストアップしました。特に、クライアントとのミーティングや提出物の準備について、スケジュールを調整しました。
- 15:00～18:00　
  - メールの整理と来週の準備を行いました。重要なメールに返信し、来週の業務に必要な情報を確認しました。
  - 技術的な学習時間を設け、最新のトレンドやツールについて調査しました。特に、業務で使用しているツールの新機能について確認し、効率化の方法を検討しました。`,
    '2025-11-03': `# 日報

## 基本情報
- **日付**：2025年11月3日
- **氏名**：

## 本日の業務内容
- 9:00～12:00　
  - 文化の日（祝日）のため、通常業務は休業でした。ただし、緊急対応が必要な案件については、リモートで対応しました。
  - 来週提出予定の提案書の作成を進めました。自宅で作業環境を整え、資料の作成とデータの整理を行いました。特に、市場分析のセクションについて、追加の調査を行いました。
- 13:00～15:00　
  - 提案書の作成を継続しました。競合分析のセクションを完成させ、我々のソリューションの優位性を明確に示す内容に仕上げました。
  - 来週のスケジュールを整理し、優先度の高いタスクをリストアップしました。特に、クライアントとのミーティングや提出物の準備について、スケジュールを確認しました。
- 15:00～18:00　
  - メールの整理と来週の準備を行いました。重要なメールに返信し、来週の業務に必要な情報を確認しました。
  - 技術的な学習時間を設け、最新のトレンドやツールについて調査しました。特に、Cursorの新機能について確認し、業務に活かせる方法を検討しました。`,
    '2025-11-04': `# 日報

## 基本情報
- **日付**：2025年11月4日
- **氏名**：

## 本日の業務内容
- 9:00～12:00　
  - 週明けのデイリースタンドアップに参加し、週末の進捗と今週の予定を共有しました。特に、今週中に完了予定の重要案件について、各メンバーの状況を確認し、必要に応じてリソースの調整を行いました。
  - 先週末に完了したプロジェクトの振り返りミーティングに参加しました。成功した点と改善点を整理し、今後のプロジェクトに活かせる知見を共有しました。特に、コミュニケーション体制やスケジュール管理について、具体的な改善案を議論しました。
  - 新規プロジェクトのキックオフミーティングに参加しました。プロジェクトの目的とスコープを確認し、各メンバーの役割分担を決定しました。初回のマイルストーンを設定し、スケジュールを確定しました。
- 13:00～15:00　
  - クライアント向けの提案書の最終確認を行いました。内容の整合性をチェックし、データの正確性を確認しました。デザイン面の調整も行い、提出準備を整えました。明日中にクライアントに提出する予定です。
  - マーケティングチームと共に、先月実施したキャンペーンの振り返りを行いました。KPIの達成状況を分析し、成功要因と改善点を整理しました。次回のキャンペーンに活かせる知見をまとめました。
- 15:00～18:00　
  - 開発チームと連携し、新機能の仕様を最終確認しました。ステークホルダーからの要望を反映し、仕様書を更新しました。開発スケジュールを再確認し、リリース日を確定しました。
  - 社内の技術勉強会の企画を進めました。テーマを決定し、講師の選定を行いました。参加者の募集を開始し、会場の確保も進めました。
  - 来月開催予定のセミナーの準備を開始しました。テーマと内容を検討し、アウトラインを作成しました。講師への依頼も行い、日程調整を開始しました。`,
    '2025-11-05': `# 日報

## 基本情報
- **日付**：2025年11月5日
- **氏名**：

## 本日の業務内容
- 9:00～12:00　
  - デイリースタンドアップで、今週のタスクの優先順位を確認しました。特に、今週中に完了すべき重要案件について、各メンバーの進捗を共有し、必要に応じてサポート体制を整えました。
  - 先週末に提出した提案書に対するクライアントからのフィードバックを確認しました。いくつかの修正点について、関係部署と相談し、対応方針を決定しました。修正版の提出期限を確認し、スケジュールを調整しました。
  - Cursor講座の参加者募集を開始しました。告知文を作成し、社内の各種チャンネルで共有しました。定員を設定し、参加希望者の受付を開始しました。
- 13:00～15:00　
  - クライアントとのオンラインミーティングに参加しました。提案書の内容について詳細な説明を行い、質問に回答しました。追加の要望についても確認し、次回までに検討結果を提示することを約束しました。
  - マーケティングチームと共に、来月の広告キャンペーンの企画を進めました。ターゲット層の設定とメッセージングを議論し、複数のアプローチを検討しました。ABテストの設計についても検討を開始しました。
- 15:00～18:00　
  - 開発チームと連携し、新機能の開発状況を確認しました。ステージング環境でのテストを実施し、いくつかの軽微な問題を発見しました。修正対応を依頼し、リリース前の最終確認を予定しました。
  - 動画制作プロジェクトの企画書を作成しました。クライアントの要望を整理し、制作内容とスケジュール、予算を明記しました。明日中にクライアントに提出する予定です。
  - 社内勉強会の準備を進めました。来週開催予定の勉強会のテーマを決定し、資料の作成を開始しました。参加者のレベルに合わせて、実践的な内容を盛り込む予定です。`,
    '2025-11-06': `# 日報

## 基本情報
- **日付**：2025年11月6日
- **氏名**：

## 本日の業務内容
- 9:00～12:00　
  - デイリースタンドアップで、今週の重要タスクの進捗を確認しました。特に、来週提出予定の提案書について、各メンバーの担当部分の進捗状況を共有し、スケジュールの調整を行いました。
  - クライアント向けの提案書の作成を開始しました。まず、プロジェクトの背景と目的を整理し、提案の骨子を作成しました。市場分析のセクションについて、必要なデータの収集を依頼しました。
  - 来週開催予定のCursor講座の企画を進めました。参加者の事前アンケート結果を分析し、期待される内容やレベル感を把握しました。これに基づいて、講座の構成を再検討しました。
- 13:00～15:00　
  - 既存顧客との定期ミーティングに参加しました。現在進行中のプロジェクトの進捗を報告し、顧客からのフィードバックを受け取りました。いくつかの要望について、実現可能性を検討し、次回までに回答することを約束しました。
  - 広告キャンペーンの効果測定結果を分析しました。先月実施したABテストのデータを集計し、各バリエーションのパフォーマンスを比較しました。結果を基に、次回のキャンペーン戦略を検討しました。
- 15:00～18:00　
  - 動画編集プロジェクトのキックオフミーティングに参加しました。クライアントの要望を詳細に確認し、制作スケジュールと納期を確定しました。各工程の担当者を決定し、コミュニケーション体制を整えました。
  - 開発チームと連携し、新機能のリリース準備を進めました。ステージング環境での最終テストを実施し、問題がないことを確認しました。リリースノートの作成も完了し、明日の本番リリースに向けて準備を整えました。
  - セミナー開催の企画を進めました。テーマと講師の選定について検討し、候補を絞り込みました。会場の選定についても、複数の候補をリストアップし、比較検討を開始しました。`,
    '2025-11-07': `# 日報

## 基本情報
- **日付**：2025年11月7日
- **氏名**：

## 本日の業務内容
- 9:00～12:00　
  - 朝のデイリースタンドアップに参加し、チームメンバーと進捗状況を共有しました。特に、明日提出予定の提案スライドの進捗について確認し、必要に応じてサポートを依頼しました。
  - 提案スライドの作成を進めました。市場分析データの収集と整理を行い、競合他社の情報を調査しました。データの信頼性を確保するため、複数の情報源から情報を収集し、比較検討しました。
  - 明日開催予定のCursor講座の資料作成を開始しました。参加者のレベルに合わせて、基礎から応用まで段階的に学べる構成を検討し、アウトラインを作成しました。
- 13:00～15:00　
  - 新規顧客との商談の事前準備を行いました。顧客の業界や課題について調査し、我々のソリューションがどのように貢献できるかを整理しました。商談で使用する資料の準備も進めました。
  - 広告クリエイティブの企画会議に参加しました。マーケティングチームと共に、ターゲット層の分析結果を共有し、訴求ポイントを議論しました。複数のアプローチを検討し、ABテストの候補案を絞り込みました。
- 15:00～18:00　
  - 動画編集チームと中間レビューの日程調整を行いました。クライアントの要望を再確認し、レビュー時に確認すべきポイントをリストアップしました。納期についても再確認し、スケジュールを調整しました。
  - 開発チームから報告のあったバグについて調査を開始しました。ログイン機能に関する不具合の原因を特定するため、ログを確認し、再現手順を整理しました。明日中に修正対応を完了する予定です。
  - セミナー会場の候補について、追加で2件の見積もり依頼を行いました。既存の候補と比較するため、設備やアクセス、料金について詳細な情報を収集しました。`,
    '2025-11-08': `# 日報

## 基本情報
- **日付**：2025年11月8日
- **氏名**：

## 本日の業務内容
- 9:00～12:00　
  - 週末（土曜日）のため、通常業務は休業でした。ただし、緊急対応が必要な案件については、リモートで対応しました。来週提出予定の提案スライドの最終確認を行い、市場分析データと競合比較を盛り込み、我々のソリューションの優位性を明確に示す構成に仕上げました。完成後、上司にレビュー依頼を送付し、フィードバック待ちの状態です。
  - Slackワークフローの通知設定を確認し、各種チャンネルへの自動通知が正しく動作するかテストメッセージを送って検証しました。一部の設定に不備があったため修正し、正常に動作することを確認しました。
  - Cursor講座の当日資料を軽く仕上げ、参加者が実際に手を動かしながら学べるよう、ハンズオンの手順を詳細に整理しました。各ステップで必要な操作と期待される結果を明確に記載し、スムーズな進行ができるよう準備を整えました。
- 13:00～15:00　
  - 来週の新規顧客との商談に向けて、事前準備を行いました。顧客の業界や課題について調査し、我々のソリューションがどのように貢献できるかを整理しました。商談で使用する資料の準備も進めました。
  - 広告クリエイティブ案を3案作成し、それぞれ異なるアプローチで訴求ポイントを変えたバリエーションを用意しました。来週、社内のマーケティングチームと相談し、どの案でABテストを実施するか、またテストの期間や評価指標についても議論する予定です。
- 15:00～18:00　
  - 来週の動画編集チームとの中間レビューに向けて、クライアントの要望を再確認し、レビュー時に確認すべきポイントをリストアップしました。納期についても再確認し、スケジュールを調整しました。
  - 開発チームから報告のあったバグについて調査を進めました。ログイン機能に関する不具合の原因を特定するため、ログを確認し、再現手順を整理しました。来週月曜日に修正対応を完了する予定です。
  - セミナー開催の会場候補を2つ比較検討しました。それぞれの会場の設備、アクセス、料金を詳細に確認し、参加者数や必要な機材を考慮した見積もりをまとめました。来週中に最終決定する予定です。
  - 来週のスケジュールを整理し、優先度の高いタスクをTodoリストに落とし込みました。特に緊急度の高い案件については、必要な準備資料や連絡事項を確認し、スムーズに業務を開始できるよう準備を整えました。`
};

// タスク種類のキーワードマッピング
const TASK_KEYWORDS = {
    '提案書': ['提案書', '提案スライド', '提案', '資料作成'],
    '商談': ['商談', '顧客', 'クライアント', 'ミーティング'],
    '開発': ['開発', 'バグ', '修正', 'リリース', 'デプロイ', 'テスト', '機能'],
    '動画編集': ['動画', '編集', '制作'],
    'セミナー': ['セミナー', '講座', '勉強会', '会場'],
    '広告': ['広告', 'キャンペーン', 'クリエイティブ', 'ABテスト', 'マーケティング'],
    'Slack': ['Slack', 'ワークフロー', '通知'],
    'その他': []
};

// 時間帯の定義
const TIME_SLOTS = {
    '9:00～12:00': 'morning',
    '13:00～15:00': 'afternoon',
    '15:00～18:00': 'evening'
};

// グローバル変数
let allTasks = [];
let charts = {};

// 初期化
document.addEventListener('DOMContentLoaded', () => {
    try {
        loadAllReports();
        analyzeTasks();
        updateSummary();
        createVisualizations();
        updateTaskTable();
        hideLoading();
        showContent();
    } catch (error) {
        console.error('エラーが発生しました:', error);
        showError();
    }
});

// すべての日報データを読み込む
function loadAllReports() {
    allTasks = [];
    
    for (const [dateKey, text] of Object.entries(REPORT_DATA)) {
        try {
            const tasks = parseReport(text, dateKey);
            console.log(`日報 ${dateKey}: ${tasks.length}件のタスクを抽出`);
            allTasks.push(...tasks);
        } catch (error) {
            console.warn(`日報データの解析エラー: ${dateKey}`, error);
        }
    }
    console.log(`合計 ${allTasks.length}件のタスクを読み込みました`);
}

// 日報テキストをパースしてタスクを抽出
function parseReport(text, dateKey) {
    const tasks = [];
    const lines = text.split('\n');
    
    // 日付を抽出（dateKeyから生成、または日報データから抽出）
    let date = null;
    let inBusinessContent = false;
    let currentTimeSlot = null;
    
    // dateKeyから日付を生成（例：2025-11-01 → 2025年11月1日）
    if (dateKey && dateKey.match(/^\d{4}-\d{2}-\d{2}$/)) {
        const [year, month, day] = dateKey.split('-');
        date = `${year}年${parseInt(month)}月${parseInt(day)}日`;
    }
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmedLine = line.trim();
        
        // 日付を抽出（- **日付**：の形式に対応、dateKeyから生成できなかった場合のフォールバック）
        if (!date && trimmedLine.includes('**日付**：')) {
            const dateMatch = trimmedLine.match(/\*\*日付\*\*：(.+)/);
            if (dateMatch) {
                date = dateMatch[1].trim();
            }
        }
        
        // 本日の業務内容セクションに入った
        if (trimmedLine === '## 本日の業務内容') {
            inBusinessContent = true;
            continue;
        }
        
        // 次のセクションに入ったら終了
        if (inBusinessContent && trimmedLine.startsWith('## ')) {
            break;
        }
        
        // 時間帯を検出（全角スペースにも対応、trimしない）
        if (inBusinessContent && line.match(/^- 9:00～12:00/)) {
            currentTimeSlot = '9:00～12:00';
            continue;
        }
        if (inBusinessContent && line.match(/^- 13:00～15:00/)) {
            currentTimeSlot = '13:00～15:00';
            continue;
        }
        if (inBusinessContent && line.match(/^- 15:00～18:00/)) {
            currentTimeSlot = '15:00～18:00';
            continue;
        }
        
        // タスクを抽出（時間帯内のリスト項目）
        // 2つのスペースの後に`-`が続く形式を検出（trimしない）
        if (inBusinessContent && currentTimeSlot) {
            // 行の先頭に2つ以上のスペースがあり、その後に`-`が続く形式を検出
            const taskMatch = line.match(/^[\s\t]{2,}- (.+)$/);
            if (taskMatch) {
                const taskText = taskMatch[1].trim();
                if (taskText && taskText.length > 0) {
                    const taskType = categorizeTask(taskText);
                    tasks.push({
                        date: date || '不明',
                        timeSlot: currentTimeSlot,
                        text: taskText,
                        type: taskType
                    });
                }
            }
        }
    }
    
    return tasks;
}

// タスクを種類別に分類
function categorizeTask(taskText) {
    for (const [type, keywords] of Object.entries(TASK_KEYWORDS)) {
        if (type === 'その他') continue;
        for (const keyword of keywords) {
            if (taskText.includes(keyword)) {
                return type;
            }
        }
    }
    return 'その他';
}

// タスクを分析
function analyzeTasks() {
    // 分析結果はグローバル変数に保存
    // 可視化関数で使用
}

// 統計サマリーを更新
function updateSummary() {
    const totalReports = new Set(allTasks.map(t => t.date)).size;
    const totalTasks = allTasks.length;
    const avgTasks = totalReports > 0 ? (totalTasks / totalReports).toFixed(1) : 0;
    
    // 日付範囲を計算
    const dates = Array.from(new Set(allTasks.map(t => t.date))).sort();
    const dateRange = dates.length > 0 
        ? `${dates[0]} ～ ${dates[dates.length - 1]}`
        : '-';
    
    document.getElementById('total-reports').textContent = totalReports;
    document.getElementById('total-tasks').textContent = totalTasks;
    document.getElementById('avg-tasks').textContent = avgTasks;
    document.getElementById('date-range').textContent = dateRange;
}

// 可視化を作成
function createVisualizations() {
    createTaskTypeChart();
    createTimeSlotChart();
    createDailyTaskChart();
    createTaskFrequencyChart();
}

// タスク種類別の円グラフ
function createTaskTypeChart() {
    const typeCount = {};
    allTasks.forEach(task => {
        typeCount[task.type] = (typeCount[task.type] || 0) + 1;
    });
    
    const labels = Object.keys(typeCount);
    const data = Object.values(typeCount);
    const colors = generateColors(labels.length);
    
    const ctx = document.getElementById('taskTypeChart').getContext('2d');
    if (charts.taskType) {
        charts.taskType.destroy();
    }
    
    charts.taskType = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 1,
                borderColor: 'rgba(255, 255, 255, 0.9)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        font: {
                            size: 12,
                            family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
                        },
                        color: '#2C3E50'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(44, 62, 80, 0.95)',
                    padding: 12,
                    titleFont: {
                        size: 13,
                        weight: 'normal'
                    },
                    bodyFont: {
                        size: 12
                    },
                    cornerRadius: 6,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value}件 (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// 時間帯別の棒グラフ
function createTimeSlotChart() {
    const slotCount = {
        '9:00～12:00': 0,
        '13:00～15:00': 0,
        '15:00～18:00': 0
    };
    
    allTasks.forEach(task => {
        if (slotCount.hasOwnProperty(task.timeSlot)) {
            slotCount[task.timeSlot]++;
        }
    });
    
    const ctx = document.getElementById('timeSlotChart').getContext('2d');
    if (charts.timeSlot) {
        charts.timeSlot.destroy();
    }
    
    charts.timeSlot = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(slotCount),
            datasets: [{
                label: 'タスク数',
                data: Object.values(slotCount),
                backgroundColor: 'rgba(107, 142, 159, 0.7)',
                borderColor: 'rgba(107, 142, 159, 0.9)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#6C7A89',
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: '#E8E8E8',
                        lineWidth: 1
                    }
                },
                x: {
                    ticks: {
                        color: '#6C7A89',
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(44, 62, 80, 0.95)',
                    padding: 12,
                    cornerRadius: 6
                }
            }
        }
    });
}

// 日付別タスク数の折れ線グラフ
function createDailyTaskChart() {
    const dailyCount = {};
    allTasks.forEach(task => {
        dailyCount[task.date] = (dailyCount[task.date] || 0) + 1;
    });
    
    const dates = Object.keys(dailyCount).sort();
    const counts = dates.map(date => dailyCount[date]);
    
    const ctx = document.getElementById('dailyTaskChart').getContext('2d');
    if (charts.dailyTask) {
        charts.dailyTask.destroy();
    }
    
    charts.dailyTask = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'タスク数',
                data: counts,
                borderColor: 'rgba(107, 142, 159, 0.9)',
                backgroundColor: 'rgba(107, 142, 159, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: 'rgba(107, 142, 159, 0.9)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#6C7A89',
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: '#E8E8E8',
                        lineWidth: 1
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        color: '#6C7A89',
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                tooltip: {
                    backgroundColor: 'rgba(44, 62, 80, 0.95)',
                    padding: 12,
                    cornerRadius: 6
                }
            }
        }
    });
}

// タスク出現頻度ランキング（上位10件）
function createTaskFrequencyChart() {
    // タスクテキストの出現頻度を計算（簡易版：最初の30文字で比較）
    const taskFrequency = {};
    allTasks.forEach(task => {
        const key = task.text.substring(0, 30);
        taskFrequency[key] = (taskFrequency[key] || 0) + 1;
    });
    
    // 頻度順にソート
    const sorted = Object.entries(taskFrequency)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    
    const labels = sorted.map(([text, _]) => text.length > 30 ? text.substring(0, 30) + '...' : text);
    const data = sorted.map(([_, count]) => count);
    
    const ctx = document.getElementById('taskFrequencyChart').getContext('2d');
    if (charts.taskFrequency) {
        charts.taskFrequency.destroy();
    }
    
    charts.taskFrequency = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '出現回数',
                data: data,
                backgroundColor: 'rgba(107, 142, 159, 0.7)',
                borderColor: 'rgba(107, 142, 159, 0.9)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#6C7A89',
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: '#E8E8E8',
                        lineWidth: 1
                    }
                },
                y: {
                    ticks: {
                        color: '#6C7A89',
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(44, 62, 80, 0.95)',
                    padding: 12,
                    cornerRadius: 6
                }
            }
        }
    });
}

// タスク詳細テーブルを更新
function updateTaskTable() {
    const tbody = document.getElementById('taskTableBody');
    tbody.innerHTML = '';
    
    // 日付順にソート
    const sortedTasks = [...allTasks].sort((a, b) => {
        if (a.date < b.date) return -1;
        if (a.date > b.date) return 1;
        return 0;
    });
    
    sortedTasks.forEach(task => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${task.date}</td>
            <td>${task.timeSlot}</td>
            <td>${task.type}</td>
            <td>${task.text}</td>
        `;
        tbody.appendChild(row);
    });
}

// カラーを生成（北欧風パステルカラー）
function generateColors(count) {
    const colors = [
        'rgba(107, 142, 159, 0.7)',  // 北欧ブルー
        'rgba(168, 197, 160, 0.7)',  // パステルグリーン
        'rgba(212, 165, 116, 0.7)',  // ベージュ
        'rgba(180, 200, 220, 0.7)',  // ライトブルー
        'rgba(200, 180, 160, 0.7)',  // サンド
        'rgba(160, 180, 200, 0.7)',  // スカイブルー
        'rgba(190, 170, 150, 0.7)',  // ウォームグレー
        'rgba(170, 190, 210, 0.7)',  // パウダーブルー
        'rgba(200, 190, 180, 0.7)',  // ストーン
        'rgba(150, 170, 190, 0.7)'   // ミストブルー
    ];
    
    const result = [];
    for (let i = 0; i < count; i++) {
        result.push(colors[i % colors.length]);
    }
    return result;
}

// ローディングを非表示
function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

// コンテンツを表示
function showContent() {
    document.getElementById('content').style.display = 'block';
}

// エラーを表示
function showError() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
}

